# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Solana-based game** where users operate upgradable "generators" that generate USDC over time. The game revolves around three interconnected loops:

1. **Generator Loop** - Item acquisition and generator upgrades
2. **Generator Runtime Loop** - Daily USDC generation and distribution
3. **Factory Loop** - Token acquisition through mock trading

### Game Economy
- **In-game token**: Custom SPL token (referred to as "$token")
- **In-game currency**: "Balance" (purchased with fiat, used for factory trades)
- **Reward token**: USDC (generated by generators, distributed daily)

Token acquisition methods:
- Buy on DEX (Raydium)
- Buy via factory loop (sometimes cheaper, but requires waiting)

## Project Structure

This is a **Yarn workspace monorepo** containing:

### Workspace Layout
- **Root**: Workspace orchestration with Yarn 4.x, Supabase integration
- **packages/dapp**: Full-stack Solana dApp with React frontend and Anchor program
- **packages/db**: Supabase database package
  - `supabase/migrations/`: Database migrations
  - Supabase JS client wrapper
  - Shared package for DB access across other packages
- **Backend API**: Express + TypeScript (location TBD)
- **Autonomous Runtimes**: Node.js + TypeScript services (location TBD)
  - Generator runtime executor
  - Trade resolver

The `packages/dapp` directory contains:
- **anchor/**: Anchor Solana program (Rust) with IDL, tests, and generated client
- **src/**: React/Vite frontend application
  - **features/**: Feature-based organization (dapp, account, dashboard, cluster)
    - Each feature has `data-access/` and `ui/` subdirectories
  - **components/**: Shared UI components and providers

## Game Mechanics

### 1. Generator Loop
Users manage upgradable generators that produce USDC through a daily runtime process.

**Item System:**
- Items obtained via **gacha system**: burn $token → receive random item
- Items can be stored in **inventory** or **equipped** to generator
- Equipped items upgrade generator attributes
- Generators have **slots** for item upgrades

**Progression:**
- XP system for generator upgrades
- Attributes affect runtime performance (flux generation, stability, event probability)

### 2. Generator Runtime Loop
The core USDC generation mechanism that runs daily.

**Daily Cycle:**
- Starts at a **fixed time** (same for all users)
- Generators produce "**flux**" based on their attributes
- Runtime events can occur:
  - Overheat
  - Breakdown
  - Power surge
  - Other events based on generator attributes

**Distribution:**
- At end of day, all flux is pooled
- All USDC acquired is pooled
- **USDC distributed proportionally** based on each user's flux contribution
- Formula: `user_reward = (user_flux / total_flux) * total_usdc_pool`

### 3. Factory Loop
Token acquisition system through simulated trading.

**Flow:**
1. User purchases "**balance**" (in-game currency)
2. Selects a free **trade slot** in their factory
3. Chooses a **trade mode** (different durations, same token rewards)
4. Trade costs X balance
5. Trade simulates a **long position with liquidation line**:
   - If price falls below liquidation line before trade ends → **liquidated** (lose balance)
   - If survive entire duration → get **balance refund + full tokens**
   - Partial survival → get **proportional tokens** (50% time = 50% tokens)
6. All trade modes yield **same amount of tokens**, only duration differs

**Unlocks:**
- Factory has **trade slots** that can be unlocked
- Purchase "**factory-engine**" (abstract name) to enable parallel trades
- More slots = more parallel trades = faster token acquisition

**Progression:**
- XP system for factory upgrades

## Common Commands

### Development Workflow
```bash
# From packages/dapp directory:
npm run dev                # Start Vite dev server
npm run anchor-localnet    # Start local validator with program deployed
npm run anchor-test        # Run Anchor tests

# CI/Build
npm run build              # TypeScript compile + Vite build
npm run lint               # ESLint
npm run format             # Prettier format
npm run format:check       # Prettier check
npm run ci                 # Full CI: build + lint + format check + codama
```

### Anchor Program
```bash
# Initial setup - sync program keys and generate client
npm run setup              # Runs: anchor keys sync && codama:js

# Individual commands
npm run anchor-build       # Build the Anchor program
npm run anchor keys sync   # Sync program ID across config and code
npm run codama:js          # Generate JS SDK from IDL using codama

# Deploy
npm run anchor deploy --provider.cluster devnet
```

Note: All Anchor commands can be run from packages/dapp using `npm run anchor <command>` or from `packages/dapp/anchor` using `anchor <command>` directly.

## Architecture

### Tech Stack
- **Frontend**: React 19, Vite, TypeScript, React Router 7
  - **Solana SDK**: [Gill](https://gill.site/) (modern Solana SDK)
  - **Wallet Integration**: @wallet-ui/react with Gill adapter
  - **State Management**: TanStack Query (@tanstack/react-query) + Jotai
  - **Styling**: Tailwind CSS 4, Shadcn UI components
- **Backend API**: Express + TypeScript
- **Database**: Supabase (hosted)
  - Migrations in `packages/db/supabase/migrations`
  - Supabase JS client for database access
  - Realtime subscriptions for autonomous runtimes
- **On-chain**: Anchor framework (Rust)
- **Client Generation**: Codama (generates TypeScript SDK from Anchor IDL)
- **Autonomous Services**: Node.js + TypeScript
  - Generator runtime executor (runs daily cycles)
  - Trade resolver (resolves factory trades)

### System Architecture

**Client → Backend → Database → Blockchain**

1. **Frontend (React + Gill)**
   - User interactions and wallet connections
   - Solana transactions via Gill SDK
   - API calls to Express backend
   - Direct database queries via Supabase client (for read-heavy operations)

2. **Backend API (Express + TypeScript)**
   - REST endpoints for game logic
   - User authentication and authorization
   - Database access via Supabase client
   - Solana program interactions via Anchor/Codama generated clients

3. **Database (Supabase)**
   - PostgreSQL database for game state
   - User data, generators, items, inventory, trades
   - Realtime subscriptions for triggering autonomous services

4. **Autonomous Runtimes (Node.js + TypeScript)**
   - **Generator Runtime Executor**:
     - Subscribes to Supabase realtime events
     - Runs daily at fixed time
     - Calculates flux generation for each user
     - Handles runtime events (overheat, breakdown, power surge)
     - Distributes USDC proportionally at end of day
   - **Trade Resolver**:
     - Monitors active trades via realtime subscriptions
     - Tracks price movements against liquidation lines
     - Resolves trades (liquidated vs. survived)
     - Calculates token rewards based on survival time
     - Updates user balance and token holdings

5. **Blockchain (Solana)**
   - Custom SPL token program
   - Generator on-chain state (if applicable)
   - USDC transfers
   - Item NFTs (if applicable)

### Provider Hierarchy
App providers wrap the application in this order (outermost to innermost):
1. `ReactQueryProvider` - TanStack Query for data fetching
2. `ThemeProvider` - Theme management (next-themes)
3. `SolanaProvider` - Wallet UI + Gill integration
   - Configures clusters (localnet, devnet)
   - Wraps children with `WalletUiGillProvider`

### Feature Organization Pattern
Features follow a consistent structure:
- **{feature}-feature.tsx**: Main feature component
- **data-access/**: React Query hooks and mutations
  - `use-{action}-mutation.ts`: Mutations (write operations)
  - `use-get-{resource}-query.ts`: Queries (read operations)
  - `use-invalidate-get-{resource}-query.ts`: Query invalidation helpers
  - `use-get-{resource}-query-key.ts`: Query key factories
- **ui/**: Presentational components
  - `{feature}-ui-{component}.tsx`: UI components

### Anchor to Frontend Flow
1. Write Anchor program in `anchor/programs/dapp/src/lib.rs`
2. Build program: `npm run anchor-build` (generates IDL in `anchor/target/idl/`)
3. Sync program ID: `npm run anchor keys sync` (updates `Anchor.toml`, `lib.rs`, and `dapp-exports.ts`)
4. Generate client: `npm run codama:js` (uses `anchor/codama.js` config to generate TypeScript SDK in `anchor/src/client/js/generated/`)
5. Export from `anchor/src/dapp-exports.ts` for use in React components
6. Create data-access hooks in `src/features/{feature}/data-access/`
7. Build UI components in `src/features/{feature}/ui/`

### Codama Configuration
The `anchor/codama.js` file uses a temporary workaround for a Gill issue (see comment in file). It configures:
- IDL input path: `target/idl/dapp.json`
- Client output path: `anchor/src/client/js/generated`

### Current Anchor Program
The example program (`packages/dapp/anchor/programs/dapp/src/lib.rs`) implements a simple "greet" instruction that logs "GM!" on-chain. Program ID: `JAVuBXeBZqXNtS73azhBDAoYaaAFfo4gWXoZe2e7Jf8H`

**Note:** This is a template program and will be replaced with actual game logic for:
- SPL token minting/burning (gacha system)
- Generator state management
- Item inventory and equipment
- USDC distribution
- Factory trade mechanics

## Routes (Planned)

### Current (Template)
- `/` - Dashboard
- `/account` - Account list
- `/account/:address` - Account detail
- `/dapp` - Interact with the Anchor program

### Future (Game Features)
- `/` or `/dashboard` - Main dashboard
- `/generator` - Generator management and upgrades
  - View current generator state
  - Equip/unequip items
  - Manage inventory
  - Gacha system interface
- `/generator/runtime` - Real-time generator runtime monitoring
  - View flux generation
  - Monitor events (overheat, breakdown, power surge)
  - Track daily progress
- `/factory` - Factory/trading interface
  - Purchase balance
  - Select trade slots
  - Choose trade modes
  - Monitor active trades
- `/factory/history` - Trade history and results
- `/inventory` - Item inventory management
- `/leaderboard` - Flux generation rankings
- `/wallet` or `/account/:address` - Wallet management and USDC balances

## Database Schema Considerations

Key entities that will need database tables:

- **Users**: Wallet address, XP, stats
- **Generators**: Per-user generator state, attributes, equipped items
- **Items**: Item definitions (types, rarities, attributes)
- **Inventory**: User-owned items (equipped vs. in storage)
- **Generator Runtimes**: Daily runtime records, flux generated, events
- **Trades**: Active and completed factory trades
- **Balances**: User in-game currency balances
- **Token Transactions**: History of $token burns, rewards
- **USDC Distributions**: Daily USDC distribution records

## Development Workflow Notes

### Adding New Game Features
1. **Define database schema** in `packages/db/supabase/migrations`
2. **Create/update Anchor programs** for on-chain logic
3. **Build Anchor program** and generate TypeScript client with Codama
4. **Implement backend API endpoints** in Express
5. **Create React feature** following the feature organization pattern:
   - `{feature}-feature.tsx` - Main component
   - `data-access/` - React Query hooks
   - `ui/` - UI components
6. **Add route** to `app-routes.tsx`

### Working with Autonomous Runtimes
- Runtimes use Supabase realtime subscriptions as event triggers
- Ensure database changes emit proper events for runtime triggers
- Test runtimes independently before integrating with main app
- Consider using separate deployment/scaling for autonomous services
